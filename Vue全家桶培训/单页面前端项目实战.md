# 单页面前后端分离应用实战
单页Web应用（single page web application，SPA），顾名思义就是只有一个html页面的web应用，页面跳转，样式动态渲染等用户交互，全部由JavaScript来控制，这样不需要刷新整个页面实现跳转，页面静态资源不需要重复引用，需要渲染这么内容是异步加载，所以速度快，体验更好，web app能有native app的速度和流畅。由于是单页面，如果所有代码都写在一个页面的话显然是不合理的，所以模块化就显得非常重要。
## 实战项目会员管理系统介绍
会员管理系统，基于**Vue+Vuex+Element UI+Axios**开发的前后端分离，由**MockJS**服务提供模拟数据接口。包括**登录、注销、修改密码、首页、会员管理、供应商管理、商品管理、用户管理**模块。
示例项目代码已开源到码云上：https://gitee.com/pjhpeter/vue-project.git

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/194640_677241b8_5449551.png "屏幕截图.png")

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/194941_ddefad9e_5449551.png "屏幕截图.png")

## MockJS介绍
### 什么是MockJS
MockJS是可以根据一定规则生成虚拟数据的工具，前后端分离的开发模式，前端开发人员都是根据Web API文档用MockJS来模拟真实数据，从而实现模拟向后端发送请求，获取响应数据的。

官方文档在这：https://github.com/nuysoft/Mock/wiki

### MockJS语法
```json
"name|rule": value
```
MockJS语法采用数据模板定义规范（DTD），分成三部分

+ name：名称
+ rule：规则，同样的规则根据value的数据类型不同会有不同效果
+ value：值

值可以用@占位符来表明调用MockJS的Random对象方法

### 举个例子

1. 创建mock-demo项目，并用Yarn初始化
2. 按照MockJS
```cmd
yarn add mockjs -D
```
3. 在项目根目录创建test.js
```js
const Mock = require('mockjs')

const data = Mock.mock({
    'list|10': [ // list的规则为10，list是数组，该规则的意思是创建10个元素
        {
            'id': 1,
            'name': '张三'
        }
    ]
})

console.log(data)
```
4. 用NodeJS来运行看效果
```cmd
node test
```

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/202514_cde583c6_5449551.png "屏幕截图.png")

> list数组生成了10个元素，但是每个元素都是一样的，这显然不是我们想要的模拟真实数据

5. 再修改一下test.js

```js
const Mock = require('mockjs')

const data = Mock.mock({
    'list|10': [ // list的规则为10，list是数组，该规则的意思是创建10个元素
        {
            'id|+1': 1, // id添加了+1的规则，id是数字类型，所以会从value开始自增1
            'name': '@cname' // value用了@占位符，这里代表调用了Mock的Random对象的cname方法，随机生成中文姓名
        }
    ]
})

console.log(data)
```

再执行一次

```cmd
node test
```

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/203327_fd08068c_5449551.png "屏幕截图.png")

## RAP2

### 什么是RAP2

RAP2是有阿里巴巴提供的免费MockJS数据模拟服务平台。

官网在这：http://rap2.taobao.org/

### RAP2使用

1. 注册账号并登录

2. 新建仓库mock-demo

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/204604_7d59fc14_5449551.png "屏幕截图.png")

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/204744_414da80a_5449551.png "屏幕截图.png")

3. 进入mock-demo仓库新建模块

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/205014_b5afcf53_5449551.png "屏幕截图.png")

4. 新建接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/205241_68260d42_5449551.png "屏幕截图.png")

5. 点击编辑，找到响应内容一栏，点击导入

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/205432_9d5b2a7f_5449551.png "屏幕截图.png")

6. 将写入json数据

```json
{
    "list|10": [
        {
            "id|+1": 1,
            "name": "@cname"
        }
    ]
}
```

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/205722_a907c530_5449551.png "屏幕截图.png")

保存后效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/205838_aef2fa7d_5449551.png "屏幕截图.png")

> list只有1个元素，并不是我们想要的效果，我们的规则是要给list创建10个元素
> 原因是RAP2的bug，导入JSON的时候，规则会被忽略
> 解决方法在上面生成的响应内容中修改

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/210239_ff84815d_5449551.png "屏幕截图.png")

这时响应数据就是我们想要的了

> 编辑完接口一定要记得保存

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/210350_7e904262_5449551.png "屏幕截图.png")

7. 测试接口

点击下图的地址就可以测试接口，**但是只能测试get请求**

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/210817_c7489bce_5449551.png "屏幕截图.png")

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/211014_3d44cb15_5449551.png "屏幕截图.png")

> 记住红色圈围住的地址，这个就是你的仓库地址，以后在这个仓库创建的所有接口都要用这个地址来访问
> 这里只是简单普及一下MockJS的使用，具体怎么在前端开发中使用后面做项目会讲解

## 项目环境搭建
### 安装Vue CLI
**这里为了演示方便选择的全局安装，真实项目中最好还是局部安装**
```cmd
yarn global add @vue/cli -D
```

### 基于Vue CLI 4 .x创建项目
创建项目vue-member-manager
```cmd
vue create vue-member-manager
```
+ 选这4项：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/212116_d975ded3_5449551.png "屏幕截图.png")

+ 不用历史路由
+ 选第4项

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/212434_72025a77_5449551.png "屏幕截图.png")

+ 选第1项

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/212538_8859f447_5449551.png "屏幕截图.png")

+ 选第1项

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/212715_c0b55b25_5449551.png "屏幕截图.png")

### 启动测试
```cmd
cd vue-member-manager
yarn serve
```

看到效果就创建成功了

![输入图片说明](https://images.gitee.com/uploads/images/2019/1226/213534_fa9921c2_5449551.png "屏幕截图.png")

### 项目初始化
#### 修改public/index.html
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title>会员管理系统</title>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
```

#### 修改.eslintrc.js
```js
module.exports = {
  root: true,
  env: {
    node: true
  },
  extends: ["plugin:vue/essential", "@vue/prettier"],
  rules: {
    "no-console": process.env.NODE_ENV === "production" ? "error" : "off",
    "no-debugger": process.env.NODE_ENV === "production" ? "error" : "off",
    // 不检查定义变量但未使用的情况，一定要添加这一项，不然无论是打包还是提交代码都会因为有变量定义了没使用报错
    "no-unused-vars": "off"
  },
  parserOptions: {
    parser: "babel-eslint"
  }
};

```

#### 更换ICO图标
+ 找一个.ico小图标替换public/favicon.ico
+ 然后清除浏览器缓存，一定要选**时间不限**
#### 删除这3个文件
![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/004428_404f7d01_5449551.png "屏幕截图.png")
#### 修改src/router/index.js
```js
import Vue from "vue";
import VueRouter from "vue-router";

Vue.use(VueRouter);

const routes = [];

const router = new VueRouter({
  routes
});

export default router;
```
#### 修改src/App.vue
```vue
<template>
  <div id="app"></div>
</template>

<style></style>
```
#### 配置vue.config.js
在项目根目录下创建vue.config.js
```js
// Vue CLI将webpack.config.js封装起来，不建议我们直接修改，用vue.config.js来代替
module.exports = {
    devServer: {
        port: 8888, // 端口号
        host: 'localhost', // 主机名
        https: false, // 是否启用https协议访问应用
        open: true // 是否项目启动后马上打开浏览器访问
    },

    lintOnSave: false, // 是否开启保存时进行代码检查
    productionSourceMap: false // 打包时不会生成.map文件，加快打包速度
}
```
> Vue CLI将webpack.config.js封装起来，不建议我们直接修改，用vue.config.js来代替
> 配置项参考文档：https://cli.vuejs.org/zh/config/

#### 安装第三方库
+ 安装Axios
```cmd
yarn add axios
```
+ 安装Element UI
```cmd
yarn add element-ui
```
Element UI时基于Vue的前端UI组件，Vue本身不具备UI组件功能，使用Element UI给Vue提供UI功能。
Elemnt UI官网在这：https://element.eleme.cn/

#### 整合Element UI
+ 修改src/main.js
```js
import Vue from "vue";
import ElementUI from "element-ui"; // 引入Element UI
import "element-ui/lib/theme-chalk/index.css"; // 引入Element UI的默认样式
import App from "./App.vue";
import router from "./router";
import store from "./store";

// 使用Element UI
Vue.use(ElementUI);

// 消息提示环境配置，是否生产环境
// 开发环境下，Vue会提供很多警告信息，方便调试代码
// 生产环境下，Vue只会提供必要的错误信息
// process.env是全局环境变量，NODE_ENV是production或者development
Vue.config.productionTip = process.env.NODE_ENV === 'production';

new Vue({
  router,
  store,
  render: h => h(App)
}).$mount("#app");
```
#### 安装两个vscode插件
+ HTML CSS Support
提供HTML和CSS的快捷提示

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/003911_b51c1f89_5449551.png "屏幕截图.png")

+ Element UI Snippets
提供Element UI的快捷提示

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/004005_fe8e7daa_5449551.png "屏幕截图.png")

### 封装Axios
#### 编写request.js
在src目录下创建uitls目录，然后创建src/utils/request.js
```js
// 引入axios
import axios from 'axios'

// 创建一个axios对象
const request = axios.create({
    // 请求配置参考: https://github.com/axios/axios#request-config
    // baseURL参数是所有请求的路径前缀
    // 比如baseURL: '/dev-api'，调用axios.get('/test')，真正的请求路径是/dev-api/test
    baseURL: '/',
    timeout: 5000
})

// 导出request对象
export default request
```
#### 测试一下
1. 在public目录下创建db.json
```json
[
    {"id": 1, "name": "嬴政"},
    {"id": 2, "name": "百里守约"},
    {"id": 3, "name": "亚瑟"}
]
```
2. 在src目录下创建api目录，然后创建src/api/test.js
```js
// 引入request
import request from '@/utils/request' // @符号是代表src的绝对路径

// public目录下的内容打包后会在项目根目录中，所以这里不需要加public路径
request.get('http://localhost:8888/db.json').then(response => {
    console.log(response.data);
})
```
3. 修改App.vue
```vue
<template>
  <div id="app"></div>
</template>

<script>
// 引入test.js测试axios封装
import testAPI from '@/api/test'

export default {
  
}
</script>

<style></style>
```
4. 启动服务查看结果
```cmd
yarn serve
```
![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/012859_c98232c2_5449551.png "屏幕截图.png")

#### 访问RAP2的test接口
1. 修改test.js
```js
// 引入request
import request from '@/utils/request' // @符号是代表src的绝对路径

request.get('http://rap2api.taobao.org/app/mock/240993/test').then(response => {
    console.log(response.data);
})
```
2. 看效果

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/121231_4e032596_5449551.png "屏幕截图.png")

3. 把数据渲染到App.vue中

**修改test.js**

```js
// 引入request
import request from '@/utils/request' // @符号是代表src的绝对路径

export default function(){
    // axios每次调用都会返回一个Promise对象
    // 将Promise对象返回，在App.vue再处理返回的数据
    return request.get('http://rap2api.taobao.org/app/mock/240993/test')
}
```

**修改App.vue**

```vue
<template>
  <div id="app">
    <ul>
      <li v-for="item in list" :key="item.id" v-text="item.name"></li>
    </ul>
  </div>
</template>

<script>
// 引入test.js测试axios封装
import testAPI from '@/api/test'

export default {
  data() {
    return {
      list: []
    }
  },
  created() {
    this.getData()
  },
  methods: {
    getData(){
      testAPI().then(response => {
        const resp = response.data
        this.list = resp.list
      })
    }
  },
}
</script>

<style></style>
```

**看到效果**

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/123959_f8ed1e07_5449551.png "屏幕截图.png")

**重构代码**

上面的代码是**黄金段位**的程序员写的，看看**钻石段位**程序员会怎么写

重构request.js

```js
// 引入axios
import axios from 'axios'

// 由于每次请求都会请求这个地址，所以可以把这个地址抽出来
const BASE_URL = 'http://rap2api.taobao.org/app/mock/240993'

// 创建一个axios对象
const request = axios.create({
    // 请求配置参考: https://github.com/axios/axios#request-config
    // baseURL参数是所有请求的路径前缀
    // 比如baseURL: '/dev-api'，调用axios.get('/test')，真正的请求路径是/dev-api/test
    baseURL: BASE_URL,
    timeout: 5000
})

// 导出request对象
export default request
```
重构test.js

```js
// 引入request
import request from '@/utils/request' // @符号是代表src的绝对路径

export default function () {
    // axios每次调用都会返回一个Promise对象
    // 将Promise对象返回，在App.vue再处理返回的数据
    // return request.get('http://rap2api.taobao.org/app/mock/240993/test')

    // 由于RAP2的地址已经抽到baseURL中，请求时会自动拼接，所以这里不需要再写RAP2的地址了
    return request.get('/test')
}
```

> 这里直接用Ajax请求向RAP2发请求，实际上是跨域了，但是请求依然成功了
> 原因是RAP2的响应头里面包含了：Access-Control-Allow-Origin: http://localhost:8888
> 所以是RAP2为我们做了跨域处理
> 不过在真实开发的过程中，前端不可能要求后端在每一个请求响应头是都加上Access-Control-Allow-Origin
> 这样也是不安全的，所以**跨域需要前端自己处理**

### 跨域处理
#### 添加请求代理
修改vue.config.js
```js
// Vue CLI将webpack.config.js封装起来，不建议我们直接修改，用vue.config.js来代替
module.exports = {
  devServer: {
    port: 8888, // 端口号
    host: "localhost", // 主机名
    https: false, // 是否启用https协议访问应用
    open: true, // 是否项目启动后马上打开浏览器访问
    // 代理配置
    proxy: {
      // 匹配/dev-api的请求
      '/dev-api': {
        // 代理转发地址
        target: 'http://rap2api.taobao.org/app/mock/240993',// 这个地址根据自己仓库地址定义
        // 在本地开启一个虚拟服务发送请求和接收数据，这样服务与服务之间不会存在跨域问题
        changeOrigin: true,
        // 路径字符串替换
        pathRewrite: {
          // 假如axios发请求到/dev-api/test
          // 经过代理的请求路径会变成http://rap2api.taobao.org/app/mock/240993/dev-api/test
          // 把路径中的/dev-api字符串替换成空字符串，就是把/dev-api去掉
          // 最终请求路径会编程http://rap2api.taobao.org/app/mock/240993/test
          '^/dev-api': ''
        }
      }
    }
  },

  lintOnSave: false, // 是否开启保存时进行代码检查
  productionSourceMap: false // 打包时不会生成.map文件，加快打包速度
};

```
#### 修改request.js
```js
// 引入axios
import axios from 'axios'

// 由于每次请求都会请求这个地址，所以可以把这个地址抽出来
// const BASE_URL = 'http://rap2api.taobao.org/app/mock/240993'

// 设置成代理服务匹配的地址
const BASE_URL = '/dev-api'

// 创建一个axios对象
const request = axios.create({
    // 请求配置参考: https://github.com/axios/axios#request-config
    // baseURL参数是所有请求的路径前缀
    // 比如baseURL: '/dev-api'，调用axios.get('/test')，真正的请求路径是/dev-api/test
    baseURL: BASE_URL,
    timeout: 5000
})

// 导出request对象
export default request
```
#### 重启服务看效果
修改了vue.config.js需要重启服务
效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/134346_c40b7255_5449551.png "屏幕截图.png")

> 现在我们已经通过代理服务发请求了，不用再担心跨域的问题
> 但是生产环境下，请求地址肯定不是RAP2了，需要配置真实的后端服务地址
> 如果想开发环境访问RAP2，生产环境访问真实后端服务地址，怎么动态切换呢？
> 我们需要为项目定义环境变量

### 环境变量

在项目根目录创建两个.env开头的文件配置环境变量

+ .env.development
+ .env.production

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/140058_a1cfcb31_5449551.png "屏幕截图.png")

#### 编写两个.env文件
**.env.development**

```env
VUE_APP_BASE_URL = http://rap2api.taobao.org/app/mock/240993
VUE_APP_SERVICE_URI = /dev-api
```

**.env.production**

```env
VUE_APP_SERVICE_URI = /prod-api
```

> 环境变量的命名必须有**VUE_APP**前缀
> 在JS中通过**process.env.**变量名调用
> 执行**serve**和**test:unit**命令时，会使用后缀为development的环境变量配置
> 执行**build**和**test:e2e**命令时，会使用后缀为production的环境变量配置

#### 修改vue.config.js
```js
// Vue CLI将webpack.config.js封装起来，不建议我们直接修改，用vue.config.js来代替
module.exports = {
  devServer: {
    port: 8888, // 端口号
    host: "localhost", // 主机名
    https: false, // 是否启用https协议访问应用
    open: true, // 是否项目启动后马上打开浏览器访问
    // 代理配置
    proxy: {
      // 匹配/dev-api的请求
      [process.env.VUE_APP_SERVICE_URI]: { // 用变量名来做key需要用中括号包裹
        // 代理转发地址
        target: process.env.VUE_APP_BASE_URL,// 这个地址根据自己仓库地址定义
        // 在本地开启一个虚拟服务发送请求和接收数据，这样服务与服务之间不会存在跨域问题
        changeOrigin: true,
        // 路径字符串替换
        pathRewrite: {
          // 假如axios发请求到/dev-api/test
          // 经过代理的请求路径会变成http://rap2api.taobao.org/app/mock/240993/dev-api/test
          // 把路径中的/dev-api字符串替换成空字符串，就是把/dev-api去掉
          // 最终请求路径会编程http://rap2api.taobao.org/app/mock/240993/test
          ['^'+ process.env.VUE_APP_SERVICE_URI]: '' // 用变量名来做key需要用中括号包裹
        }
      }
    }
  },

  lintOnSave: false, // 是否开启保存时进行代码检查
  productionSourceMap: false // 打包时不会生成.map文件，加快打包速度
};

```

#### 修改request.js

```js
// 引入axios
import axios from 'axios'

// 由于每次请求都会请求这个地址，所以可以把这个地址抽出来
// const BASE_URL = 'http://rap2api.taobao.org/app/mock/240993'

// 设置成代理服务匹配的地址
// const BASE_URL = '/dev-api'

// 这里读取环境变量
const BASE_URL = process.env.VUE_APP_SERVICE_URI

// 创建一个axios对象
const request = axios.create({
    // 请求配置参考: https://github.com/axios/axios#request-config
    // baseURL参数是所有请求的路径前缀
    // 比如baseURL: '/dev-api'，调用axios.get('/test')，真正的请求路径是/dev-api/test
    baseURL: BASE_URL,
    timeout: 5000
})

// 导出request对象
export default request
```

重启服务看效果

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/142439_277c09c7_5449551.png "屏幕截图.png")

#### 生产环境部署

打包项目
```cmd
yarn build
```

把项目dist重命名后复制到Nginx的html目录下

> 不懂就参考[Vue进阶](Vue进阶.md)的**前端项目的部署**章节

修改nginx.conf的server配置
```shell
location / {
    # 根目录指向项目目录
    root   html/vue-member-manager;
    index  index.html index.htm;
}

# 添加访问代理
# 匹配/prod-api请求
location /prod-api {
    # 由于现在没有真实后端服务，所以还是用RAP2做演示
    proxy_pass   http://rap2api.taobao.org/app/mock/240993;
}
```

启动Nginx服务看效果，浏览器访问localhost

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/145240_fd3e173e_5449551.png "屏幕截图.png")

> 到这里为止项目环境算是搭建完成了
> 代码质量也从**钻石段位**升到了**王者段位**了
> 国服？管他呢-_-
> 下面就是建立代码管理

## 把代码托管给码云
### 在码云上创建vue-member-manager

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/155253_21f0f439_5449551.png "屏幕截图.png")

> 记得把这一项的钩去掉，免得麻烦

### 本地git添加远程仓库
Vue CLI创建的项目会自动添加本地git仓库的，所以不需要用**git init**命令初始化项目。

添加远程仓库，在项目根目录进入命令行，执行命令

```cmd
git remote add gitee git@gitee.com:pjhpeter/vue-member-manager.git
```

> 后面的路径是自己的仓库路径
> 路径前的gitee参数是给这个远程仓库起的别名
> 以后推送或拉取代码都可以用别名来操作，不需要输入很长的地址

vscode中提交代码到本地仓库

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/162406_e400e6f5_5449551.png "屏幕截图.png")

点击这3ge点就有推送项了

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/163048_343c0823_5449551.png "屏幕截图.png")

选**push to...**

在vscode顶上出现输入框，就可以选择刚才添加的仓库**gitee**了

> 上面两步截不了图，没办法
>
> 好像多推送几次就可以不用**push to...**了，直接可以push了

代码就推送到码云了

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/163810_09263bed_5449551.png "屏幕截图.png")

> 下面开始正式开发项目功能
> 下一章节是整个项目最难最难的地方，前方高能！！！！！做好心理准备~

## 登录功能
### 新建login分支
在码云上点击master，然后点击管理

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/165520_1519b63f_5449551.png "屏幕截图.png")

点击新建分支，输入login，点击提交

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/165633_64d3b4b6_5449551.png "屏幕截图.png")

在项目根目录下进入cmd，执行命令

```cmd
git pull gitee
```
这时会看到新建了分支的提示

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/170306_50194e85_5449551.png "屏幕截图.png")

切换成login分支

```cmd
git checkout login
```

查看当前分支

```cmd
git branch
```

看到分支已经切换成**login**了

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/170649_471e1679_5449551.png "屏幕截图.png")

### 需求分析
验证**用户名**和**密码**后才能登录，按**登录按钮**和按**回车键**都可以登录

![输入图片说明](https://images.gitee.com/uploads/images/2019/1227/172138_df0d14f1_5449551.png "屏幕截图.png")

### 配置路由
1. 在src/views目录下创建login文件夹，在login文件夹下创建index.vue
2. 修改src/router/index.js

```js
import Vue from "vue";
import VueRouter from "vue-router";
// 引入login组件
import Login from "@/views/login"; // 引入资源时，直接指向资源所在的文件夹，默认会引入文件夹下的index.vue

Vue.use(VueRouter);

const routes = [
  {
    // 登录界面
    path: "/login",
    component: Login
  }
];

const router = new VueRouter({
  routes
});

export default router;

```

3. 修改App.vue

```vue
<template>
  <div id="app">
    <router-view></router-view>
  </div>
</template>

<style>
  /* App.vue是整个应用的入口组件，这里一般会自定一些全局的样式，比如统一字体、body样式等 */
  body {
    font-family: Avenir,Tahoma,Arial,PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,Helvetica,sans-serif;
  }
</style>

```

### 登录页面
1. 编写src/views/login/index.vue
```vue
<template>
  <div class="login-content">
    <el-form :model="form" ref="form" label-width="80px" class="login-form">
      <h2 class="login-title">会员管理系统</h2>
      <el-form-item label="账号">
        <el-input v-model="form.username" placeholder="请输入账号"></el-input>
      </el-form-item>
      <el-form-item label="密码">
        <el-input type="password" v-model="form.password" placeholder="请输入密码"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="login">登录</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      form: {
        username: "",
        password: ""
      }
    };
  },
  methods: {
    login() {}
  }
};
</script>

<style scoped>
.login-content {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-image: url("~@/assets/background.jpg"); /*在style中引用@全局路径，前面需要添加~*/
  background-size: 100%; /*背景图过尺寸大时，添加这个属性让背景图适应页面大小*/
}

.login-form {
  width: 350px;
  background-color: rgb(255, 255, 255, 0.8);
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 30px;
  border-radius: 20px;
}

.login-title {
  text-align: center;
  color: #303133;
}
</style>
```

2. 找一张背景图放到src/assets目录下，刷新一下看效果

### 表单校验
通过data的rules属性来约定验证规则，通过el-form-item的prop属性来指定需要验证的字段名。
1. 在el-form中绑定rules属性，在el-from-item中添加prop属性
```vue
<template>
  <div class="login-content">
    <el-form :model="form" :rules="rules" ref="form" label-width="80px" class="login-form">
      <h2 class="login-title">会员管理系统</h2>
      <el-form-item label="账号" prop="username">
        <el-input v-model="form.username" placeholder="请输入账号"></el-input>
      </el-form-item>
      <el-form-item label="密码" prop="password">
        <el-input type="password" v-model="form.password" placeholder="请输入密码"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="login">登录</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>
```

2. 在data中添加rules属性
```js
data() {
  return {
    form: {
      username: "",
      password: ""
    },
    rules: {
      username: [{ required: true, message: "请输入账号", trigger: "blur" }],
      password: [{ required: true, message: "请输入密码", trigger: "blur" }]
    }
  };
}
```

3. login方法添加表单提交校验
```js
login() {
  // Vue时通过ref属性来获取template中的元素的
  this.$refs["form"].validate(vald => {
    if (vald) {
      // 登录
      console.log(this.form.username);
      console.log(this.form.password);
    } else {
      console.log("登录失败");
      return false;
    }
  });
}
```

### 添加按回车键登录
修改src/views/login/index.vue的template
```vue
<template>
  <div class="login-content">
    <el-form :model="form" :rules="rules" ref="form" label-width="80px" class="login-form">
      <h2 class="login-title">会员管理系统</h2>
      <el-form-item label="账号" prop="username">
        <!-- Element的组件如果要绑定原生事件，需要添加.native修饰符 -->
        <!-- 想了解监听键盘输入事件更多信息看文档：https://cn.vuejs.org/v2/guide/events.html#%E6%8C%89%E9%94%AE%E4%BF%AE%E9%A5%B0%E7%AC%A6 -->
        <el-input v-model="form.username" placeholder="请输入账号" @keypress.enter.native="login"></el-input>
      </el-form-item>
      <el-form-item label="密码" prop="password">
        <el-input
          type="password"
          v-model="form.password"
          placeholder="请输入密码"
          @keypress.enter.native="login"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="login">登录</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>
```

### RAP2中添加登录接口
1. 新建登录模块，新建登录验证接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1228/142410_574d4365_5449551.png "屏幕截图.png")

2. 导入响应数据

```json
{
    "code": 2000,
    "flag": true,
    "message": "验证成功",
    "data": {
        "token": "admin"
    }
}
```

3. 新建获取用户信息接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1228/143006_e4792aed_5449551.png "屏幕截图.png")

4. 导入响应数据

```json
{
    "code": 2000,
    "flag": true,
    "message": "成功获取用户信息",
    "data": {
        "id|1-10000": 1,
        "name": "@cname",
        "roles": [
            "manager"
        ]
    }
}
```

> 导入完后记得要手动修改id的规则

### 登录逻辑实现
1. 在src/api目录下创建login.js
```js
// 引入request
import request from "@/utils/request"

// 登录
export function login(username, password) {
    return request({
        url: "/user/login",
        method: "post",
        data: {
            username,
            password
        }
    });
};

// 通过token获取用户信息
export function getUserInfo(token) {
    return request({
        url: `/user/info/${token}`,
        method: "get"
    });
};
```

2. 修改src/views/login/index.vue的login方法
```js
login() {
      // Vue时通过ref属性来获取template中的元素的
      this.$refs["form"].validate(vald => {
        if (vald) {
          // 登录
          login(this.username, this.password).then(response => {
            const resp = response.data;
            if (resp.flag) {
              let token = resp.data.token;
              // 将token保存到本地缓存
              localStorage.setItem("user-token", token);
              // 获取用户信息
              getUserInfo(token).then(response => {
                const resp = response.data;
                if (resp.flag) {
                  // 将用户信息保存到本地缓存
                  localStorage.setItem("user-info", JSON.stringify(resp.data));
                  // 跳转到首页
                  this.$router.push("/");
                } else {
                  this.$message({
                    type: "warning",
                    message: resp.message
                  });
                }
              });
            } else {
              // Element提示信息，参考https://element.eleme.cn/#/zh-CN/component/message#message-xiao-xi-ti-shi
              this.$message({
                type: "warning",
                message: resp.message
              });
            }
          });
        } else {
          return false;
        }
      });
    }
  }
```
### 用Vuex保存全局状态信息
Vuex是Vue官方提供的插件，用来管理状态信息，在Vue的项目中，推荐用Vuex来管理token和用户信息等全局数据，同时也可以管理常量。
#### Vuex介绍
Vuex的使用方法如下：
```js
import Vue from "vue";
import Vuex from "vuex";

Vue.use(Vuex);

export default new Vuex.Store({
  // 全局状态信息
  state: {
    id: 0,
    name: ""
  },
  // mutations，用于改变state的值，但不写任何业务逻辑，类似JAVA的DAO层
  mutations: {
    // mutations中的方法推荐使用全大写命名
    SET_ID(state, id){// id是外面传入的参数，有个专业名称叫载荷
      state.id = id;
    },
    SET_NAME(state, name){
      state.name = name;
    }
  },
  // actions，用于编写业务逻辑代码，然后调用mutations去改变state的值
  actions: {
    // actions中的方法推荐使用首字母大写的驼峰式命名
    SetUser(context, id, name){
      // 业务代码
      // ......
      
      // 调用mutations，通过context.commit方法的第一个参数指定mutations的方法
      context.commit("SET_ID", id);
      context.commit("SET_NAME", name);
    }
  }
});
```
在其他组件中调用**Vuex**
```js
// 读取值
this.$store.state.name;

// 改变值
this.$store.dispatch("SetUser", id, name);
```
还可以模块化
```js
import Vue from "vue";
import Vuex from "vuex";

const user = {
  state: {
    id: 0,
    name: ""
  },
  mutations: {
    // 一些东西
  },
  actions: {
    // 一些东西
  }
}

Vue.use(Vuex);

export default new Vuex.Store({
  state: {},
  mutations: {},
  actions: {},
  modules: {
    user
  }
});
```

模块化的情况下要调用state的属性需要添加模块名user
```js
this.$store.state.user.name;
```

> 这里先简单介绍一下，感兴趣的去这里https://vuex.vuejs.org/zh/

#### 封装localStorage读写
在src/utils目录下创建auth.js，对localStorage的操作进行封装，方便调用。
```js
const TOKEN_KEY = "user-token";

const USER_INFO_KEY = "user-info";

// 获取token
export function getToken() {
    return localStorage.getItem(TOKEN_KEY);
}

// 保存token
export function setToken(token) {
    localStorage.setItem(TOKEN_KEY, token);
}

// 获取用户信息
export function getUserInfo() {
    return localStorage.getItem(JSON.parse(USER_INFO_KEY));
}

// 保存用户信息
export function setUserInfo(userInfo) {
    localStorage.setItem(USER_INFO_KEY, JSON.stringify(userInfo));
}

// 注销用户
export function logout() {
    localStorage.removeItem(USER_INFO_KEY);
    localStorage.removeItem(TOKEN_KEY);
}
```

#### 添加user的Vuex模块
1. 在src/store目录下创建modules文件夹,在modules文件夹下创建user.js
```js
// Vuex只能保证整个应用的所有组件都能拿到用户信息，但是刷新页面会清空，所以还是要在localStorage中存一份
import * as auth from "@/utils/auth";

import { login, getUserInfo } from "@/api/login"

const user = {
    state: {
        token: auth.getToken(), // 初始化与localStorage同步
        user: auth.getUserInfo() // 初始化与localStorage同步
    },
    mutations: {
        SET_TOKEN(state, token) {
            state.token = token;
            auth.setToken(token);
        },
        SET_USER_INFO(state, user) {
            state.user = user;
            auth.setUserInfo(user);
        }
    },
    actions: {
        // 将login的请求逻辑放到这里
        Login({ commit }, form) {
            // Promise是ES6处理异步请求的新方式，axios的链式调用也是通过Promise来实现的
            // resolve是成功的回调函数，其参数会作为then方法的参数传入
            // reject是失败的回调函数，其参数会作为catch方法的参数传入
            return new Promise((resolve, reject) => {
                login(form.username, form.password).then(response => {
                    const resp = response.data;
                    // 缓存token信息
                    commit("SET_TOKEN", resp.data.token);
                    resolve(resp);
                }).catch(error => {
                    reject(error);
                });
            });
        },
        // 获取用户信息的请求逻辑放到这里
        GetUserInfo({ commit }, token) {
            return new Promise((resolve, reject) => {
                getUserInfo(token).then(response => {
                    const resp = response.data;
                    // 缓存用户信息
                    commit("SET_USER_INFO", resp.data);
                    resolve(resp);
                }).catch(error => {
                    reject(error);
                });
            });
        }
    }
};

export default user;
```

2. 修改src/store/index.js
```js
import Vue from "vue";
import Vuex from "vuex";
// 引入user模块
import user from "./modules/user"

Vue.use(Vuex);

export default new Vuex.Store({
  state: {},
  mutations: {},
  actions: {},
  modules: {
    user // 添加user模块
  }
});

```

3. 修改src/views/login/index.vue的login方法
```js
login() {
  // Vue时通过ref属性来获取template中的元素的
  this.$refs["form"].validate(vald => {
    if (vald) {
      // 登录
      this.$store
        .dispatch("Login", this.form)
        .then(resp => {
          // 获取用户信息
          this.$store
            .dispatch("GetUserInfo", resp.data.token)
            .then(resp => {
              // 路由跳转
              this.$router.push("/");
            });
        });
    } else {
      return false;
    }
  });
}
```
> 现在可以正常登录了，但是如果直接在浏览器里面输入localhost:8888会直跳过登录页
> 所以必须要做一个浏览器的访问拦截

### 浏览器访问拦截
需求是这样，浏览器的访问除了login以外的路径全部都必须要登录才能访问，所以拦截的思路如下：
1. 是否访问login？如果是直接放行，不是继续下面判断
2. localStorage中是否有token，如果没有，跳转到login，如果有继续下面判断
3. localStorage中是否有用户信息，如果有直接跳转，如果没有则向后台请求用户信息
4. 请求用户信息成功后直接跳转，如果请求用户信息失败说明token有问题，跳转到login

根据上面的思路，在src目录下创建promission.js
```js
// 路由访问拦截是通过router的beforeEach方法实现
import router from "./router";

import store from "./store";

/*
 * from Route 从哪里来
 * to Route 到哪里去
 * next Function 重定向方法
 */
router.beforeEach((to, from, next) => {
    // 判断访问路径是否login
    if (to.path === "/login") {
        // 直接放行
        next();
    } else {
        // 判断localStorage有没有token
        const token = store.state.user.token;
        if (!token) {
            // 重定向到登录页
            next("/login");
        } else {
            // 判断localStorage中是否有用户信息
            const user = store.state.user.user;
            if (!user) {
                // 获取用户信息
                store.dispatch("GetUserInfo", token).then(resp => {
                    next();
                }).catch(error => {
                    next("/login");
                });
            } else {
                next();
            }
        }
    }
});
```
> 这里会获取用户信息，所以src/views/login/index.vue中就不需要获取了

修改src/views/login/index.vue
```js
login() {
  // Vue时通过ref属性来获取template中的元素的
  this.$refs["form"].validate(vald => {
    if (vald) {
      // 登录
      this.$store.dispatch("Login", this.form).then(resp => {
        // 路由跳转
        this.$router.push("/");
      });
    } else {
      return false;
    }
  });
}
```

> 终于都完成登录的功能了，万事开头难，哈哈^_^
> 还没完呢。。。刚才我们一直没有做异常处理吧
> 那是因为可以使用拦截器统一做的

### 统一拦截请求和响应
Axios提供了拦截器功能
+ axios.interceptors.request拦截请求
+ axios.interceptors.response拦截响应

修改src/utils/request.js
```js
// 引入axios
import axios from "axios";

// 引入Element UI的Message功能
import { Message } from "element-ui";

// 由于每次请求都会请求这个地址，所以可以把这个地址抽出来
// const BASE_URL = 'http://rap2api.taobao.org/app/mock/240993'

// 设置成代理服务匹配的地址
// const BASE_URL = '/dev-api'

// 这里读取环境变量
const BASE_URL = process.env.VUE_APP_SERVICE_URI;

// 创建一个axios对象
const request = axios.create({
  // 请求配置参考: https://github.com/axios/axios#request-config
  // baseURL参数是所有请求的路径前缀
  // 比如baseURL: '/dev-api'，调用axios.get('/test')，真正的请求路径是/dev-api/test
  baseURL: BASE_URL,
  timeout: 5000
});

// 请求拦截器
request.interceptors.request.use(
  config => {
    return config;
  },
  error => {
    return Promise.reject(error);
  }
);

// 响应拦截器
request.interceptors.response.use(
  response => {
    // 即使response.status等于200也有可能会有异常
    // 所以一般都需要自定义返回码规则
    // 统一异常处理
    const resp = response.data;
    // 约定成功返回码为2000
    if (resp.code !== 2000) {
      Message({
        type: "warning",
        message: resp.message ? resp.message : "系统异常"
      });
      return Promise.reject(response);
    }
    return response;
  },
  error => {
    // 这回后台真的抛异常了
    // 异常处理
    const response = error.response;
    Message({
      type: "error",
      message: (response.data && response.data.message) ? response.data.message : `系统异常，错误码为：${response.status}`
    });
    return Promise.reject(response);
  }
);

// 导出request对象
export default request;

```

> 到这里为止最难的部分已经完成啦
> 应该提交代码休息一下啦 

## 项目布局和退出
### 需求分析
项目布局为传统后台管理系统，分为header、nav-bar、main-page三部分

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/121443_c7cd564f_5449551.png "屏幕截图.png")

### 路由配置
在src/views目录下创建layout目录，来layout目录下创建index.vue
```vue
<template>
    <div>
        布局
    </div>
</template>
```
修改src/router/index.js
```js
import Vue from "vue";
import VueRouter from "vue-router";
// 引入login组件
import Login from "@/views/login"; // 引入资源时，直接指向资源所在的文件夹，默认会引入文件夹下的index.vue
// 引入layout组件
import Layout from "@/views/layout";

Vue.use(VueRouter);

const routes = [
  {
    // 登录界面
    path: "/login",
    component: Login
  },
  {
    // 项目主页面
    path: "/",
    component: Layout
  }
];

const router = new VueRouter({
  routes
});

export default router;

```

登录系统看效果

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/122649_cca183fa_5449551.png "屏幕截图.png")

### 布局实现
#### 创建组件
在src/components目录下创建layout目录，在layout目录中创建app-header.vue、app-nav-bar.vue、app-main.vue

app-header.vue
```vue
<template>
    <div>
        app-header
    </div>
</template>
```

app-nav-bar.vue
```vue
<template>
    <div>
        app-nav-bar
    </div>
</template>
```

app-main.vue
```vue
<template>
    <div>
        app-main
    </div>
</template>
```

修改src/views/layout/index.vue
```vue
<template>
  <div>
      <app-header></app-header>
      <app-nav-bar></app-nav-bar>
      <app-main></app-main>
  </div>
</template>

<script>
import AppHeader from "@/components/layout/app-header";
import AppNavBar from "@/components/layout/app-nav-bar";
import AppMain from "@/components/layout/app-main";

export default {
  components: {
    "app-header": AppHeader,
    "app-nav-bar": AppNavBar,
    "app-main": AppMain
  }
};
</script>
```

看看效果

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/125332_7e113c76_5449551.png "屏幕截图.png")

#### 调整样式
找一个图片替换src/assets/logo.png
app-header.vue
```vue
<template>
  <div class="header">
    <a href="/" class="logo-link">
      <img src="~@/assets/logo.png" class="logo" />
      <span class="logo-title">会员管理系统</span>
    </a>
  </div>
</template>

<style scoped>
.header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50px;
  line-height: 50px;
  background-color: #676262;
}

.logo-link {
  padding-left: 20px;
}

.logo {
  height: 50px;
  width: 70px;
}
.logo-title {
  position: absolute;
  font-size: 20px;
  color: #fff;
}
</style>
```

app-nav-bar.vue
```vue
<template>
  <div class="nav-bar">app-nav-bar</div>
</template>

<style scoped>
.nav-bar {
  position: absolute;
  top: 50px;
  bottom: 0px;
  left: 0px;
  width: 200px;
  background-color: #4e4e4e;
  overflow: auto;
}
</style>
```

app-main.vue
```vue
<template>
  <div class="main">app-main</div>
</template>

<style scoped>
.main {
  position: absolute;
  padding: 10px;
  top: 50px;
  bottom: 0;
  left: 200px;
  right: 0;
  overflow: auto;
}
</style>
```

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/140607_bd22a196_5449551.png "屏幕截图.png")

#### 顶部栏实现
src/components/layout目录下添加header-dropdown.vue
```vue
<template>
  <span class="header-dropdown">
    <el-dropdown trigger="click" @command="handleCommand">
      <span class="header-username">
        <!-- 从用户信息中读取用户姓名 -->
        <span v-text="user.name"></span>
        <i class="el-icon-arrow-down el-icon--right"></i>
      </span>
      <el-dropdown-menu slot="dropdown">
        <!-- 图标样式参考：https://element.eleme.cn/#/zh-CN/component/icon#tu-biao-ji-he -->
        <el-dropdown-item icon="el-icon-edit" command="changePassword">修改密码</el-dropdown-item>
        <el-dropdown-item icon="el-icon-coffee-cup" command="logout">退出</el-dropdown-item>
      </el-dropdown-menu>
    </el-dropdown>
  </span>
</template>

<script>
export default {
  data() {
    return {
      user: this.$store.state.user.user
    };
  },
  methods: {
    handleCommand(command) {
      switch (command) {
        case "changePassword":
          this.$message("修改密码");
          break;
        case "logout":
          this.$message("退出");
          break;
        default:
          break;
      }
    }
  }
};
</script>

<style scoped>
.header-dropdown {
  position: absolute;
  right: 0;
  margin-right: 40px;
}
.header-username {
  color: #fff;
  cursor: pointer;
}
</style>
```

修改src/components/layout/app-header.vue的template和script
```vue
<template>
  <div class="header">
    <a href="/" class="logo-link">
      <img src="~@/assets/logo.png" class="logo" />
      <span class="logo-title">会员管理系统</span>
    </a>
    <header-dropdown></header-dropdown>
  </div>
</template>

<script>
import HeaderDropdown from "@/components/layout/header-dropdown";

export default {
  components: {
    "header-dropdown": HeaderDropdown
  }
};
</script>
```

#### 左边导航栏实现
修改src/components/layout/app-nav-bar.vue
```vue
<template>
  <div class="nav-bar">
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/menu#navmenu-dao-hang-cai-dan -->
    <el-menu
      default-active="2"
      background-color="#4e4e4e"
      text-color="#fff"
      active-text-color="#ffd04b"
    >
      <el-menu-item index="2">
        <i class="el-icon-s-home"></i>
        <span slot="title">首页</span>
      </el-menu-item>
      <el-menu-item index="3">
        <i class="el-icon-user-solid"></i>
        <span slot="title">会员管理</span>
      </el-menu-item>
      <el-menu-item index="4">
        <i class="el-icon-s-goods"></i>
        <span slot="title">供应商管理</span>
      </el-menu-item>
      <el-menu-item index="5">
        <i class="el-icon-goods"></i>
        <span slot="title">商品管理</span>
      </el-menu-item>
      <el-menu-item index="6">
        <i class="el-icon-user"></i>
        <span slot="title">用户管理</span>
      </el-menu-item>
    </el-menu>
  </div>
</template>

<style scoped>
.nav-bar {
  position: absolute;
  top: 50px;
  bottom: 0px;
  left: 0px;
  width: 200px;
  background-color: #4e4e4e;
  overflow: auto;
}
/* Elemnt组件基本都会有一个与组件名同名的class控制样式 */
.el-menu {
  border: 0;
}
</style>
```

效果如下：

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/162327_de119eb3_5449551.png "屏幕截图.png")

**路由配置**
1. 在src/components目录下创建home、member、supplier、goods、user这5个文件夹，每个文件夹下都添加index.vue
home/index.vue
```vue
<template>
  <div class="home">
    <h1>欢迎访问会员管理系统</h1>
  </div>
</template>
```

member/index.vue
```vue
<template>
  <div>会员管理</div>
</template>
```

supplier/index.vue
```vue
<template>
  <div>供应商管理</div>
</template>
```

goods/index.vue
```vue
<template>
  <div>商品管理</div>
</template>
```

user/index.vue
```vue
<template>
  <div>用户管理</div>
</template>
```

2. 修改src/router/index.js
```js
import Vue from "vue";
import VueRouter from "vue-router";
// 引入login组件
import Login from "@/views/login"; // 引入资源时，直接指向资源所在的文件夹，默认会引入文件夹下的index.vue
// 引入layout组件
import Layout from "@/views/layout";

import Home from "@/components/home";
import Member from "@/components/member";
import Supplier from "@/components/supplier";
import Goods from "@/components/goods";
import User from "@/components/user";

Vue.use(VueRouter);

const routes = [
  {
    // 登录界面
    path: "/login",
    component: Login
  },
  {
    // 项目主页面
    path: "/",
    component: Layout,
    // 默认访问首页
    redirect: "/home",
    // app-main的内容是layout的子组件，所有用子路由
    children: [
      {
        path: "home",
        component: Home,
        meta: {// meta属性可以通过$route.meta读取，用于传递路由相关信息
          title: "首页"
        }
      },
      {
        path: "member",
        component: Member,
        meta: {
          title: "会员管理"
        }
      },
      {
        path: "supplier",
        component: Supplier,
        meta: {
          title: "供应商管理"
        }
      },
      {
        path: "goods",
        component: Goods,
        meta: {
          title: "商品管理"
        }
      },
      {
        path: "user",
        component: User,
        meta: {
          title: "用户管理"
        }
      }
    ]
  }
];

const router = new VueRouter({
  routes
});

export default router;

```

3. 修改src/components/layout/app-nav-bar.vue
```vue
<template>
  <div class="nav-bar">
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/menu#navmenu-dao-hang-cai-dan -->
    <el-menu
      :default-active="defaultActive"
      background-color="#4e4e4e"
      text-color="#fff"
      active-text-color="#ffd04b"
      :router="true"
    >
      <el-menu-item index="/home">
        <i class="el-icon-s-home"></i>
        <span slot="title">首页</span>
      </el-menu-item>
      <el-menu-item index="/member">
        <i class="el-icon-user-solid"></i>
        <span slot="title">会员管理</span>
      </el-menu-item>
      <el-menu-item index="/supplier">
        <i class="el-icon-s-goods"></i>
        <span slot="title">供应商管理</span>
      </el-menu-item>
      <el-menu-item index="/goods">
        <i class="el-icon-goods"></i>
        <span slot="title">商品管理</span>
      </el-menu-item>
      <el-menu-item index="/user">
        <i class="el-icon-user"></i>
        <span slot="title">用户管理</span>
      </el-menu-item>
    </el-menu>
  </div>
</template>

<script>
export default {
  data() {
    return {
      defaultActive: this.$route.path
    };
  }
};
</script>

<style scoped>
.nav-bar {
  position: absolute;
  top: 50px;
  bottom: 0px;
  left: 0px;
  width: 200px;
  background-color: #4e4e4e;
  overflow: auto;
}
/* Elemnt组件基本都会有一个与组件名同名的class控制样式 */
.el-menu {
  border: 0;
}
</style>
```

4. 修改src/components/layout/app-main.vue
```vue
<template>
  <div class="main">
    <router-view></router-view>
  </div>
</template>
```

#### 主页面实现
修改src/components/layout/app-main.vue，添加顶部面包屑导航栏
```vue
<template>
  <div class="main">
    <el-breadcrumb separator-class="el-icon-arrow-right" v-if="$route.path !== '/home'">
      <!-- 这里只是介绍秒面包屑导航的使用，因为面包屑只有一层，所有下面的代码时不起作用的 -->
      <el-breadcrumb-item :to="{ path: $route.path }" v-text="$route.meta.title"></el-breadcrumb-item>
    </el-breadcrumb>
    <router-view></router-view>
  </div>
</template>

<style scoped>
.main {
  position: absolute;
  top: 50px;
  bottom: 0;
  left: 200px;
  right: 0;
  padding: 10px;
  overflow: auto;
}

.el-breadcrumb {
  height: 10px;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 4px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
}
.el-breadcrumb__item {
  padding-left: 10px;
  border-left: 2px solid #31c17b;
}
</style>
```

#### 优化顶部栏logo点击效果
修改src/components/layout/app-header.vue
```vue
<template>
  <div class="header">
    <a href="javascript:;" @click="toHome" class="logo-link">
      <img src="~@/assets/logo.png" class="logo" />
      <span class="logo-title">会员管理系统</span>
    </a>
    <header-dropdown></header-dropdown>
  </div>
</template>

<script>
import HeaderDropdown from "@/components/layout/header-dropdown";

export default {
  components: {
    "header-dropdown": HeaderDropdown
  },
  methods: {
    // 用路由方式跳转首页
    toHome() {
      this.$router.push("/home");
    }
  }
};
</script>

<style scoped>
.header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50px;
  line-height: 50px;
  background-color: #676262;
}

.logo-link {
  padding-left: 20px;
}

.logo {
  height: 50px;
  width: 70px;
}
.logo-title {
  position: absolute;
  font-size: 20px;
  color: #fff;
}
</style>
```

> 修改src/components/layout/app-nav-bar.vue，处理点击logo时左侧导航栏没有选中首页的问题
> 添加$route监听器，当路由发生改变的时候同时改变导航栏选择项

```js
watch: {
    $route(newValue, oldValue) {
    this.defaultActive = newValue.path;
  }
}
```

### 退出功能
1. RAP2的login模块添加退出接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/150926_b66c101a_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
    "code": 2000,
    "flag": true,
    "message": "退出成功"
}
```

3. src/api/login.js添加logout方法
```js
// 退出
export function logout(token) {
  return request({
    url: "/user/logout",
    method: "post",
    data: {
      token
    }
  });
}
```

4. src/store/modules/user.js添加Logout处理
```js
// Vuex只能保证整个应用的所有组件都能拿到用户信息，但是刷新页面会清空，所以还是要在localStorage中存一份
import * as auth from "@/utils/auth";

import { login, getUserInfo, logout } from "@/api/login";

const user = {
  state: {
    token: auth.getToken(), // 初始化与localStorage同步
    user: auth.getUserInfo() // 初始化与localStorage同步
  },
  mutations: {
    SET_TOKEN(state, token) {
      state.token = token;
      auth.setToken(token);
    },
    SET_USER_INFO(state, user) {
      state.user = user;
      auth.setUserInfo(user);
    },
    REMOVE_TOKEN(state) {
      state.token = "";
      state.user = null;
      auth.logout();
    }
  },
  actions: {
    // 将login的请求逻辑放到这里
    Login({ commit }, form) {
      // Promise是ES6处理异步请求的新方式，axios的链式调用也是通过Promise来实现的
      // resolve是成功的回调函数，其参数会作为then方法的参数传入
      // reject是失败的回调函数，其参数会作为catch方法的参数传入
      return new Promise((resolve, reject) => {
        login(form.username, form.password)
          .then(response => {
            const resp = response.data;
            // 缓存token信息
            commit("SET_TOKEN", resp.data.token);
            resolve(resp);
          })
          .catch(error => {
            reject(error);
          });
      });
    },
    // 获取用户信息的请求逻辑放到这里
    GetUserInfo({ commit }, token) {
      return new Promise((resolve, reject) => {
        getUserInfo(token)
          .then(response => {
            const resp = response.data;
            // 缓存用户信息
            commit("SET_USER_INFO", resp.data);
            resolve(resp);
          })
          .catch(error => {
            reject(error);
          });
      });
    },
    // 退出
    Logout({ commit, state }) {
      new Promise((resolve, reject) => {
        logout(state.token).then(response => {
          const resp = response.data;
          // 清楚缓存的token和用户信息
          commit("REMOVE_TOKEN");
          resolve(resp)
        }).catch(error => {
          reject(error);
        });
      });
    }
  }
};

export default user;

```

5. 修改src/components/layout/header-dropdown.vue的script
```html
<script>
export default {
  data() {
    return {
      user: this.$store.state.user.user
    };
  },
  methods: {
    handleCommand(command) {
      switch (command) {
        case "changePassword":
          this.$message("修改密码");
          break;
        case "logout":
          this.handleLogout();
          break;
        default:
          break;
      }
    },
    // 退出处理
    handleLogout() {
      // 弹出确认对话框
      this.$confirm("确定退出系统吗？").then(() => {
        // 退出系统
        this.$store.dispatch("Logout");
        // 重定向到登录页
        this.$router.push("/login");
      });
    }
  }
};
</script>
```
> 到这里项目的框架基本搭建完成

### 提交代码与合并分支
公共功能完成，需要提交代码，并把login分支合并到master分支，后面开发业务模块都可以使用
1. 代码检查
```cmd
yarn lint
```

2. 提交代码
```cmd
git add .
git commit -m "页面布局"
git push gitee login
```

3. 合并login分支到master
```cmd
git checkout master
git pull gitee master
git merge login
git push gitee master
```

> 下面是实现会员管理、供应商管理、商品管理、用户管理四个业务模块
> 在码云上创建member、supplier、goods、user四个分支
> 最后用git pull gtiee命令拉取新建的分支

## 会员管理
### 需求分析
会员信息分页展示，可以对会员信息进行增删改查操作

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/182212_8a97b0c1_5449551.png "屏幕截图.png")

### 切换member分支
```cmd
git checkout member
```

### 创建RA2模拟数据
#### 新建会员管理模块

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/182824_32f09528_5449551.png "屏幕截图.png")

#### 获取会员列表接口
1. 新建获取会员列表接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/183029_327253f8_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
    "code": 2000,
    "flag": true,
    "message": "获取会员列表成功",
    "data": {
        "total": "@integer(200, 300)",
        "rows|10": [
            {
                "id|+1": 50,
                "cardNum": "@integer(10000)",
                "name": "@cname",
                "birthday|1564577990837-2564577990837": 0,
                "phone|11": "@integer(0, 9)",
                "integral": "@integer(0, 500)",
                "money": "@float(0, 1000, 1, 2)",
                "payType|1": [ 1, 2, 3, 4 ],
                "address": "@county(true)"
            }
        ]
    }
}
```

> 由于RAP2的bug，下面有几个地方需要修改的

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/191623_1ed496e5_5449551.png "屏幕截图.png")

修改后

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/191812_4586729e_5449551.png "屏幕截图.png")

#### 添加会员接口
1. 新建添加会员接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/191106_0213ebc0_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
  "code": 2000,
  "flag": true,
  "message": "新增成功"
}
```

#### 编辑会员接口
1. 新建编辑会员接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/222622_38a248de_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
  "code": 2000,
  "flag": true,
  "message": "修改成功"
}
```

#### 删除会员接口
1. 新建删除会员接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/222454_9a4289ec_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
  "code": 2000,
  "flag": true,
  "message": "删除成功"
}
```

#### 获取单个会员信息接口
1. 信息获取当会员信息接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/222758_784ab202_5449551.png "屏幕截图.png")

2. 响应内容导入
```json
{
    "code": 2000,
    "flag": true,
    "message": "获取成功",
    "data": {
      "id": 10,
      "cardNum": "test10",
      "name": "测试会员",
      "birthday|1564577990837-2564577990837": 0,
      "phone|11": "@integer(0,9)",
      "integral": "@integer(500,800)",
      "money": "@integer(1000,2000)",
      "payType|1": [ 1, 2, 3, 4],
      "address": "@county(true)"
    }
  }
```

3. 下面几个地方需要修改

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/192852_6d19f1be_5449551.png "屏幕截图.png")

修改后

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/193031_2767ff50_5449551.png "屏幕截图.png")

### 请求接口实现
在src/api目录下创建member.js
```js
import request from "@/utils/request";

export function getList() {
    return request({
        url: "/member/list",
        method: "get"
    });
}

export function add(entity) {
    return request({
        url: "/member",
        method: "post",
        data: entity
    });
}

export function edit(entity) {
    return request({
        url: `/member/${entity.id}`,
        method: "put",
        data: entity
    });
}

export function remove(id) {
    return request({
        url: `/member/${id}`,
        method: "delete"
    });
}

export function get(id) {
    return request({
        url: `/member/${id}`,
        method: "get"
    });
}
```

### 列表展示数据
#### 列表实现
修改src/components/member/index.vue
```vue
<template>
  <div>
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/table -->
    <el-table :data="list" border stripe :height="tableHeight">
      <el-table-column type="index" label="序号" width="50"></el-table-column>
      <el-table-column prop="name" label="姓名" width="90"></el-table-column>
      <el-table-column prop="cardNum" label="卡号"></el-table-column>
      <el-table-column prop="birthday" label="生日"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="integral" label="积分" width="90"></el-table-column>
      <el-table-column prop="money" label="余额" width="90"></el-table-column>
      <el-table-column prop="payType" label="支付方式" width="90"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="name" label="操作" width="150">
        <!-- 通过scope拿到当前点击行 -->
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEdit(scope.row.id)">编辑</el-button>
          <el-button size="mini" type="danger" @click="handleRemove(scope.row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import * as memberAPI from "@/api/member";

export default {
  data() {
    return {
      list: [],
      tableHeight: window.innerHeight - 140
    };
  },
  created() {
    this.fetchData();
  },
  mounted() {
    // 自适应屏幕高度
    window.onresize = () => {
      this.tableHeight = window.innerHeight -140;
    };
  },
  methods: {
    fetchData() {
      memberAPI.getList().then(response => {
        const resp = response.data;
        this.list = resp.data.rows;
      });
    },
    handleEdit(id) {
      this.$message(`编辑${id}`);
    },
    handleRemove(id) {
      this.$message(`删除${id}`);
    }
  }
};
</script>

```

#### 数据格式化
表格数据格式是通过el-table-column的formatter来实现的

1. 支付类型格式化

data添加payTypeOptions属性
````js
data() {
  return {
    list: [],
    tableHeight: window.innerHeight - 140,
    payTypeOption: [
      { type: 1, name: "现金" },
      { type: 2, name: "微信" },
      { type: 3, name: "支付宝" },
      { type: 4, name: "银行卡" }
    ]
  };
}
````

method添加payTypeFormatter方法
```js
payTypeFormatter(row, column, cellValue, index) {
  let payTypeOption = this.payTypeOptions.find(
    option => option.type === cellValue
  );
  return payTypeOption ? payTypeOption.name : "未知类型";
}
```

table的支付类型列添加formatter属性
```html
<el-table-column prop="payType" label="支付方式" width="90" :formatter="payTypeFormatter"></el-table-column>
```

2. 日期格式

日期格式化应该是全局工具类，全局的功能应该在master分支中开发
**先提交一下代码**，然后切换到master分支
```cmd
git checkout master
```
在src/utils目录下添加common.js
```js
(() => {
  // 网上找的日期格式化
  Date.prototype.format = function(fmt) {
    var o = {
      "M+": this.getMonth() + 1, //月份
      "d+": this.getDate(), //日
      "h+": this.getHours(), //小时
      "m+": this.getMinutes(), //分
      "s+": this.getSeconds(), //秒
      "q+": Math.floor((this.getMonth() + 3) / 3), //季度
      S: this.getMilliseconds() //毫秒
    };
    if (/(y+)/.test(fmt)) {
      fmt = fmt.replace(
        RegExp.$1,
        (this.getFullYear() + "").substr(4 - RegExp.$1.length)
      );
    }
    for (var k in o) {
      if (new RegExp("(" + k + ")").test(fmt)) {
        fmt = fmt.replace(
          RegExp.$1,
          RegExp.$1.length == 1
            ? o[k]
            : ("00" + o[k]).substr(("" + o[k]).length)
        );
      }
    }
    return fmt;
  };
  window.formatDate = function(timestamp, pattern) {
    let date = new Date(timestamp);
    return date.format(pattern);
  };
})();

```

main.js添加引用
```js
// 公共工具方法
import "./utils/common";
```

提交master修改的代码
```cmd
git add .
git commit -m "添加日期格式化工具"
git push gitee master
```

合并master代码到member分支
```cmd
git pull gitee master
git checkout member
git merge master
```

现在member分支就有了日期格式工具了，我们回到src/components/member/index.vue

methods添加dateFormmeter方法
```js
dateFormmeter(row, column, cellValue, index) {
  return window.formatDate(cellValue, "yyyy年MM月dd日");
}
```

table的生日列添加formatter属性
```html
<el-table-column prop="birthday" label="生日" :formatter="dateFormmeter"></el-table-column>
```

### 条件查询
#### 修改RAP2获取会员列表接口
请求方式改成post

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/213041_6d4dd808_5449551.png "屏幕截图.png")

#### 修改api
修改src/api/member.js的getList方法
```js
export function getList(search) {
  return request({
    url: "/member/list",
    method: "post",
    data: search
  });
}
```

#### 修改页面组件
修改src/components/member/index.vue
```vue
<template>
  <div>
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/form -->
    <!-- 条件查询表单 -->
    <el-form :model="search" ref="searchForm" inline>
      <el-form-item prop="name">
        <el-input v-model="search.name" placeholder="会员姓名" clearable></el-input>
      </el-form-item>
      <el-form-item prop="cardNum">
        <el-input v-model="search.cardNum" placeholder="卡号" clearable></el-input>
      </el-form-item>
      <el-form-item prop="payType">
        <el-select v-model="search.payType" placeholder="支付类型" clearable>
          <el-option
            v-for="option in payTypeOptions"
            :key="option.type"
            :label="option.name"
            :value="option.type"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item prop="birthday">
        <!-- 参考：https://element.eleme.cn/#/zh-CN/component/date-picker -->
        <el-date-picker
          v-model="search.birthday"
          type="date"
          placeholder="生日"
          format="yyyy年MM月dd日"
          value-format="timestamp"
        ></el-date-picker>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="fetchData">查询</el-button>
        <el-button @click="resetSearchForm">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/table -->
    <el-table :data="list" border stripe :height="tableHeight">
      <el-table-column type="index" label="序号" width="50"></el-table-column>
      <el-table-column prop="name" label="姓名" width="90"></el-table-column>
      <el-table-column prop="cardNum" label="卡号"></el-table-column>
      <el-table-column prop="birthday" label="生日" :formatter="dateFormmeter"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="integral" label="积分" width="90"></el-table-column>
      <el-table-column prop="money" label="余额" width="90"></el-table-column>
      <el-table-column prop="payType" label="支付方式" width="90" :formatter="payTypeFormatter"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="name" label="操作" width="150">
        <!-- 通过scope拿到当前点击行 -->
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEdit(scope.row.id)">编辑</el-button>
          <el-button size="mini" type="danger" @click="handleRemove(scope.row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import * as memberAPI from "@/api/member";

export default {
  data() {
    return {
      list: [],
      tableHeight: window.innerHeight - 140,
      payTypeOptions: [
        { type: 1, name: "现金" },
        { type: 2, name: "微信" },
        { type: 3, name: "支付宝" },
        { type: 4, name: "银行卡" }
      ],
      search: {
        name: "",
        cardNum: "",
        payType: null,
        birthday: null
      }
    };
  },
  created() {
    this.fetchData();
  },
  mounted() {
    // 自适应屏幕高度
    window.onresize = () => {
      this.tableHeight = window.innerHeight - 140;
    };
  },
  methods: {
    fetchData() {
      memberAPI.getList(this.search).then(response => {
        const resp = response.data;
        this.list = resp.data.rows;
      });
    },
    handleEdit(id) {
      this.$message(`编辑${id}`);
    },
    handleRemove(id) {
      this.$message(`删除${id}`);
    },
    // 支付类型格式化
    payTypeFormatter(row, column, cellValue, index) {
      let payTypeOption = this.payTypeOptions.find(
        option => option.type === cellValue
      );
      return payTypeOption ? payTypeOption.name : "未知类型";
    },
    // 日期格式化
    dateFormmeter(row, column, cellValue, index) {
      return window.formatDate(cellValue, "yyyy年MM月dd日");
    },
    // 重置条件查询表单
    resetSearchForm() {
      this.$refs["searchForm"].resetFields();
    }
  }
};
</script>

```

> data属性中search对象的所有属性都必须初始化，不然会出现文本框不能输入的问题

输入条件点击查询，看到下面效果说明成功

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/215752_d1f2f320_5449551.png "屏幕截图.png")

### 分页
#### 修改RAP2获取会员列表接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/220034_426edfcc_5449551.png "屏幕截图.png")

#### 修改api
修改src/api/member的getList方法
```js
export function getList(search, currentPage, pageSize) {
  return request({
    url: `/member/list/${currentPage}/${pageSize}`,
    method: "post",
    data: search
  });
}
```

#### 修改页面
修改src/components/member/index.vue
```vue
<template>
  <div>
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/form -->
    <!-- 条件查询表单 -->
    <el-form :model="search" ref="searchForm" inline>
      <el-form-item prop="name">
        <el-input v-model="search.name" placeholder="会员姓名" clearable></el-input>
      </el-form-item>
      <el-form-item prop="cardNum">
        <el-input v-model="search.cardNum" placeholder="卡号" clearable></el-input>
      </el-form-item>
      <el-form-item prop="payType">
        <el-select v-model="search.payType" placeholder="支付类型" clearable>
          <el-option
            v-for="option in payTypeOptions"
            :key="option.type"
            :label="option.name"
            :value="option.type"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item prop="birthday">
        <!-- 参考：https://element.eleme.cn/#/zh-CN/component/date-picker -->
        <el-date-picker
          v-model="search.birthday"
          type="date"
          placeholder="生日"
          format="yyyy年MM月dd日"
          value-format="timestamp"
        ></el-date-picker>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="fetchData">查询</el-button>
        <el-button @click="resetSearchForm">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/table -->
    <el-table :data="list" border stripe :height="tableHeight">
      <el-table-column type="index" label="序号" width="50"></el-table-column>
      <el-table-column prop="name" label="姓名" width="90"></el-table-column>
      <el-table-column prop="cardNum" label="卡号"></el-table-column>
      <el-table-column prop="birthday" label="生日" :formatter="dateFormmeter"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="integral" label="积分" width="90"></el-table-column>
      <el-table-column prop="money" label="余额" width="90"></el-table-column>
      <el-table-column prop="payType" label="支付方式" width="90" :formatter="payTypeFormatter"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="name" label="操作" width="150">
        <!-- 通过scope拿到当前点击行 -->
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEdit(scope.row.id)">编辑</el-button>
          <el-button size="mini" type="danger" @click="handleRemove(scope.row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/pagination -->
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page="currentPage"
      :page-sizes="[10, 20, 30, 40]"
      :page-size="pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="total"
      background
    ></el-pagination>
  </div>
</template>

<script>
import * as memberAPI from "@/api/member";

export default {
  data() {
    return {
      total: 0,
      list: [],
      tableHeight: window.innerHeight - 140,
      payTypeOptions: [
        { type: 1, name: "现金" },
        { type: 2, name: "微信" },
        { type: 3, name: "支付宝" },
        { type: 4, name: "银行卡" }
      ],
      search: {
        name: "",
        cardNum: "",
        payType: null,
        birthday: null
      },
      currentPage: 1,
      pageSize: 10
    };
  },
  created() {
    this.fetchData();
  },
  mounted() {
    // 自适应屏幕高度
    window.onresize = () => {
      this.tableHeight = window.innerHeight - 140;
    };
  },
  methods: {
    fetchData() {
      memberAPI
        .getList(this.search, this.currentPage, this.pageSize)
        .then(response => {
          const resp = response.data;
          this.total = resp.data.total;
          this.list = resp.data.rows;
        });
    },
    handleEdit(id) {
      this.$message(`编辑${id}`);
    },
    handleRemove(id) {
      this.$message(`删除${id}`);
    },
    // 支付类型格式化
    payTypeFormatter(row, column, cellValue, index) {
      let payTypeOption = this.payTypeOptions.find(
        option => option.type === cellValue
      );
      return payTypeOption ? payTypeOption.name : "未知类型";
    },
    // 日期格式化
    dateFormmeter(row, column, cellValue, index) {
      return window.formatDate(cellValue, "yyyy年MM月dd日");
    },
    // 重置条件查询表单
    resetSearchForm() {
      this.$refs["searchForm"].resetFields();
    },
    // 监听每页显示数量变化
    sizeChange(val) {
      this.pageSize = val;
      this.fetchData();
    },
    // 翻页
    currentChange(val) {
      this.currentPage = val;
      this.fetchData();
    }
  }
};
</script>

```

尝试翻页和改变每页显示条数，看到参数变化说明成功

![输入图片说明](https://images.gitee.com/uploads/images/2019/1229/221444_370e30e2_5449551.png "屏幕截图.png")

#### 表格自适应优化
添加了查询和分页，表格自适应高度方法需要修改
```js
mounted() {
  // 自适应屏幕高度
  // $nextTick是为了保证页面被渲染完成的方法
  this.$nextTick(() => {
    this.tableHeight =
      window.innerHeight - 172 - this.$refs["searchForm"].$el.offsetHeight;
    // 浏览器大小变化事件
    window.onresize = () => {
      this.tableHeight =
        window.innerHeight - 172 - this.$refs["searchForm"].$el.offsetHeight;
    };
  });
}
```

### 删除
修改src/components/member/index.vue

1. 添加doRemove方法

```js
doRemove(id) {
  memberAPI.remove(id).then(response => {
    // 刷新表格
    this.fetchData();
    this.$message({
      type: "success",
      message: response.data.message
    });
  });
}
```

2. 修s改handleRemove方法

```js
handleRemove(id) {
  this.$confirm("确定删除该信息吗？").then(() => {
    this.doRemove(id);
  });
}
```

### 新增
1. data属性中添加member对象、showDialog和rules属性

```js
member: {
  id: null    
  name: "",   
  cardNum: "",
  birthday: null,
  phone: "",   
  money: null,
  integral: null,
  payType: null,
  address: ""
},
showDialog: false,
rules: {
  cardNum: [
    { required: true, message: "请输入会员卡号", trigger: "blur" }
  ],
  name: [{ required: true, message: "请输入会员姓名", trigger: "blur" }],
  payType: [
    { required: true, message: "请选择支付类型", trigger: "change" }
  ]
}
```

2. methods中添加handleAdd方法

```js
// 弹出新增对话框
showMemberForm() {
  this.showDialog = true;
  // 异步事件，渲染结束后回调函数才会执行
  this.$nextTick(() => {
    // 当第一次渲染对话框是，表单dom还不存在，直接重置表单会报错
    this.$refs["memberForm"].resetFields();
  });
}
```

3. methods中添加submitForm方法

```js
// 提交数据
submitForm() {
  this.$refs["memberForm"].validate(valid => {
    if (valid) {
      memberAPI.add(this.member).then(response => {
        this.showDialog = false;
        this.fetchData();
        this.$message({
          type: "success",
          message: response.data.message
        });
      });
    } else {
      return false;
    }
  });
}
```

4. template添加编辑用户对话框

```html
<!-- 参考：https://element.eleme.cn/#/zh-CN/component/dialog -->
<!-- 会员信息对话框 -->
<el-dialog title="编辑会员" :visible.sync="showDialog" width="550px">
  <el-form
    :model="member"
    :rules="rules"
    ref="memberForm"
    label-width="100px"
    style="width: 450px"
  >
    <el-form-item prop="id" hidden>
      <el-input type="hidden" v-model="member.id"></el-input>
    </el-form-item>
    <el-form-item label="会员卡号" prop="cardNum">
      <el-input v-model="member.cardNum" placeholder="会员卡号" clearable></el-input>
    </el-form-item>
    <el-form-item label="会员姓名" prop="name">
      <el-input v-model="member.name" placeholder="会员姓名" clearable></el-input>
    </el-form-item>
    <el-form-item label="会员生日" prop="birthday">
      <el-date-picker
        v-model="member.birthday"
        type="date"
        placeholder="会员生日"
        format="yyyy年MM月dd日"
        value-format="timestamp"
      ></el-date-picker>
    </el-form-item>
    <el-form-item label="手机号码" prop="phone">
      <el-input v-model="member.phone" placeholder="手机号码" clearable></el-input>
    </el-form-item>
    <el-form-item label="开卡金额" prop="money">
      <el-input v-model="member.money" placeholder="开卡金额" clearable></el-input>
    </el-form-item>
    <el-form-item label="会员姓名" prop="integral">
      <el-input v-model="member.integral" placeholder="可用积分" clearable></el-input>
    </el-form-item>
    <el-form-item label="支付类型" prop="payType">
      <el-select v-model="member.payType" placeholder="支付类型" clearable>
        <el-option
          v-for="option in payTypeOptions"
          :key="option.type"
          :label="option.name"
          :value="option.type"
        ></el-option>
      </el-select>
    </el-form-item>
    <el-form-item label="会员姓名" prop="address">
      <el-input type="textarea" v-model="member.address" placeholder="会员地址" clearable></el-input>
    </el-form-item>
  </el-form>
  <span slot="footer">
    <el-button @click="showDialog = false">取消</el-button>
    <el-button type="primary" @click="submitForm">确定</el-button>
  </span>
</el-dialog>
```

5. searchForm添加新增按钮

```html
<el-button type="primary" @click="showMemberForm">新增</el-button>
```

### 编辑
1. 修改handleEdit方法

```js
handleEdit(id) {
  this.showMemberForm();
  // 获取单个会员信息
  memberAPI.get(id).then(response => {
    this.member = response.data.data;
  });
}
```

2. 修改submitForm方法

```js
// 提交数据
submitForm() {
  this.$refs["memberForm"].validate(valid => {
    if (valid) {
      if (this.member.id) {
        // 编辑
        memberAPI.edit(this.member.id).then(response => {
          this.showDialog = false;
          this.fetchData();
          this.$message({
            type: "success",
            message: response.data.message
          });
        });
      } else {
        // 新增
        memberAPI.add(this.member).then(response => {
          this.showDialog = false;
          this.fetchData();
          this.$message({
            type: "success",
            message: response.data.message
          });
        });
      }
    } else {
        return false;
      }
    });
  }
}
```
###  完整的页面组件代码
```vue
<template>
  <div>
    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/form -->
    <!-- 条件查询表单 -->
    <el-form :model="search" ref="searchForm" inline>
      <el-form-item prop="name">
        <el-input v-model="search.name" placeholder="会员姓名" clearable></el-input>
      </el-form-item>
      <el-form-item prop="cardNum">
        <el-input v-model="search.cardNum" placeholder="卡号" clearable></el-input>
      </el-form-item>
      <el-form-item prop="payType">
        <el-select v-model="search.payType" placeholder="支付类型" clearable>
          <el-option
            v-for="option in payTypeOptions"
            :key="option.type"
            :label="option.name"
            :value="option.type"
          ></el-option>
        </el-select>
      </el-form-item>
      <el-form-item prop="birthday">
        <!-- 参考：https://element.eleme.cn/#/zh-CN/component/date-picker -->
        <el-date-picker
          v-model="search.birthday"
          type="date"
          placeholder="生日"
          format="yyyy年MM月dd日"
          value-format="timestamp"
        ></el-date-picker>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="fetchData">查询</el-button>
        <el-button type="primary" @click="showMemberForm">新增</el-button>
        <el-button @click="resetSearchForm">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/table -->
    <el-table :data="list" border stripe :height="tableHeight">
      <el-table-column type="index" label="序号" width="50"></el-table-column>
      <el-table-column prop="name" label="姓名" width="90"></el-table-column>
      <el-table-column prop="cardNum" label="卡号"></el-table-column>
      <el-table-column prop="birthday" label="生日" :formatter="dateFormmeter"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="integral" label="积分" width="90"></el-table-column>
      <el-table-column prop="money" label="余额" width="90"></el-table-column>
      <el-table-column prop="payType" label="支付方式" width="90" :formatter="payTypeFormatter"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="name" label="操作" width="150">
        <!-- 通过scope拿到当前点击行 -->
        <template slot-scope="scope">
          <el-button size="mini" @click="handleEdit(scope.row.id)">编辑</el-button>
          <el-button size="mini" type="danger" @click="handleRemove(scope.row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/pagination -->
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page="currentPage"
      :page-sizes="[10, 20, 30, 40]"
      :page-size="pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="total"
      background
    ></el-pagination>

    <!-- 参考：https://element.eleme.cn/#/zh-CN/component/dialog -->
    <!-- 会员信息对话框 -->
    <el-dialog title="编辑会员" :visible.sync="showDialog" width="550px">
      <el-form
        :model="member"
        :rules="rules"
        ref="memberForm"
        label-width="100px"
        style="width: 450px"
      >
        <el-form-item prop="id" hidden>
          <el-input type="hidden" v-model="member.id"></el-input>
        </el-form-item>
        <el-form-item label="会员卡号" prop="cardNum">
          <el-input v-model="member.cardNum" placeholder="会员卡号" clearable></el-input>
        </el-form-item>
        <el-form-item label="会员姓名" prop="name">
          <el-input v-model="member.name" placeholder="会员姓名" clearable></el-input>
        </el-form-item>
        <el-form-item label="会员生日" prop="birthday">
          <el-date-picker
            v-model="member.birthday"
            type="date"
            placeholder="会员生日"
            format="yyyy年MM月dd日"
            value-format="timestamp"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="手机号码" prop="phone">
          <el-input v-model="member.phone" placeholder="手机号码" clearable></el-input>
        </el-form-item>
        <el-form-item label="开卡金额" prop="money">
          <el-input v-model="member.money" placeholder="开卡金额" clearable></el-input>
        </el-form-item>
        <el-form-item label="会员姓名" prop="integral">
          <el-input v-model="member.integral" placeholder="可用积分" clearable></el-input>
        </el-form-item>
        <el-form-item label="支付类型" prop="payType">
          <el-select v-model="member.payType" placeholder="支付类型" clearable>
            <el-option
              v-for="option in payTypeOptions"
              :key="option.type"
              :label="option.name"
              :value="option.type"
            ></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="会员姓名" prop="address">
          <el-input type="textarea" v-model="member.address" placeholder="会员地址" clearable></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer">
        <el-button @click="showDialog = false">取消</el-button>
        <el-button type="primary" @click="submitForm">确定</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import * as memberAPI from "@/api/member";

export default {
  data() {
    return {
      total: 0,
      list: [],
      tableHeight: window.innerHeight - 140,
      payTypeOptions: [
        { type: 1, name: "现金" },
        { type: 2, name: "微信" },
        { type: 3, name: "支付宝" },
        { type: 4, name: "银行卡" }
      ],
      search: {
        name: "",
        cardNum: "",
        payType: null,
        birthday: null
      },
      currentPage: 1,
      pageSize: 10,
      member: {
        id: null,
        name: "",
        cardNum: "",
        birthday: null,
        phone: "",
        money: null,
        integral: null,
        payType: null,
        address: ""
      },
      showDialog: false,
      rules: {
        cardNum: [
          { required: true, message: "请输入会员卡号", trigger: "blur" }
        ],
        name: [{ required: true, message: "请输入会员姓名", trigger: "blur" }],
        payType: [
          { required: true, message: "请选择支付类型", trigger: "change" }
        ]
      }
    };
  },
  created() {
    this.fetchData();
  },
  mounted() {
    // 自适应屏幕高度
    this.$nextTick(() => {
      this.tableHeight =
        window.innerHeight - 172 - this.$refs["searchForm"].$el.offsetHeight;
      // 浏览器大小变化事件
      window.onresize = () => {
        this.tableHeight =
          window.innerHeight - 172 - this.$refs["searchForm"].$el.offsetHeight;
      };
    });
  },
  methods: {
    fetchData() {
      memberAPI
        .getList(this.search, this.currentPage, this.pageSize)
        .then(response => {
          const resp = response.data;
          this.total = resp.data.total;
          this.list = resp.data.rows;
        });
    },
    handleEdit(id) {
      this.showMemberForm();
      // 获取单个会员信息
      memberAPI.get(id).then(response => {
        this.member = response.data.data;
      });
    },
    handleRemove(id) {
      this.$confirm("确定删除该信息吗？").then(() => {
        this.doRemove(id);
      });
    },
    doRemove(id) {
      memberAPI.remove(id).then(response => {
        // 刷新表格
        this.fetchData();
        this.$message({
          type: "success",
          message: response.data.message
        });
      });
    },
    // 支付类型格式化
    payTypeFormatter(row, column, cellValue, index) {
      let payTypeOption = this.payTypeOptions.find(
        option => option.type === cellValue
      );
      return payTypeOption ? payTypeOption.name : "未知类型";
    },
    // 日期格式化
    dateFormmeter(row, column, cellValue, index) {
      return window.formatDate(cellValue, "yyyy年MM月dd日");
    },
    // 重置条件查询表单
    resetSearchForm() {
      this.$refs["searchForm"].resetFields();
    },
    // 监听每页显示数量变化
    sizeChange(val) {
      this.pageSize = val;
      this.fetchData();
    },
    // 翻页
    currentChange(val) {
      this.currentPage = val;
      this.fetchData();
    },
    // 弹出新增对话框
    showMemberForm() {
      this.showDialog = true;
      // 异步事件，渲染结束后回调函数才会执行
      this.$nextTick(() => {
        // 当第一次渲染对话框是，表单dom还不存在，直接重置表单会报错
        this.$refs["memberForm"].resetFields();
      });
    },
    // 提交数据
    submitForm() {
      this.$refs["memberForm"].validate(valid => {
        if (valid) {
          if (this.member.id) {
            // 编辑
            memberAPI.edit(this.member.id).then(response => {
              this.showDialog = false;
              this.fetchData();
              this.$message({
                type: "success",
                message: response.data.message
              });
            });
          } else {
            // 新增
            memberAPI.add(this.member).then(response => {
              this.showDialog = false;
              this.fetchData();
              this.$message({
                type: "success",
                message: response.data.message
              });
            });
          }
        } else {
          return false;
        }
      });
    }
  }
};
</script>

```

> 功能完成，可以提交代码啦^_^
> 做完这个模块，后面的模块都是大同小异，这里就不再讲了，掌握了前面的内容后面的自己可以完成
> 上面的代码还可以做进一步优化的，比如日期格式，删除的确认提示等全局通用的东西，可以用Vuex作为常量管理，写在state里面就可以全局调用了
> 日期格式、表格高度自适应等功能可以作为公共插件全局加载使用
> 这些优化你们就自己做吧 

## 修改密码
### 需求分析
三个密码都是必填，填写原密码后会到后台验证密码是否正确，新密码和确认密码要保持一致

![输入图片说明](https://images.gitee.com/uploads/images/2019/1230/114133_5fa1ca3c_5449551.png "屏幕截图.png")

### 新建RAP2接口
#### 新建用户管理模块

![输入图片说明](https://images.gitee.com/uploads/images/2019/1230/113020_5ab9aeb6_5449551.png "屏幕截图.png")

#### 验证密码接口
1. 新建验证密码接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1230/111933_3ff3f810_5449551.png "屏幕截图.png")

2. 响应内容导入

```json
{
  "code": 2000,
  "flag": true,
  "message": "验证通过"
}
```

#### 修改密码接口
1. 新建修改密码接口

![输入图片说明](https://images.gitee.com/uploads/images/2019/1230/112509_f08c9495_5449551.png "屏幕截图.png")

2. 响应内容导入

```json
{
  "code": 2000,
  "flag": true,
  "message": "修改成功"
}
```

### 修改密码实现
#### 编写api
> **先切换到user分支**

在src/api目录下创建user.js

```js
import request from "@/utils/request";

export function checkPwd(userId, password) {
    return request({
        url: "/user/pwd",
        method: "post",
        data: {
            userId,
            password
        }
    });
}

export function changePwd(userId, password) {
    return request({
        url: "/user/pwd",
        method: "put",
        data: {
            userId,
            password
        }
    });
}
````

#### 业务组件

修改src/components/layout/header-dropdown.vue

```vue
<template>
  <span class="header-dropdown">
    <el-dropdown trigger="click" @command="handleCommand">
      <span class="header-username">
        <!-- 从用户信息中读取用户姓名 -->
        <span v-text="user.name"></span>
        <i class="el-icon-arrow-down el-icon--right"></i>
      </span>
      <el-dropdown-menu slot="dropdown">
        <!-- 图标样式参考：https://element.eleme.cn/#/zh-CN/component/icon#tu-biao-ji-he -->
        <el-dropdown-item icon="el-icon-edit" command="changePassword">修改密码</el-dropdown-item>
        <el-dropdown-item icon="el-icon-coffee-cup" command="logout">退出</el-dropdown-item>
      </el-dropdown-menu>
    </el-dropdown>

    <!-- 修改密码对话框 -->
    <el-dialog title="修改密码" :visible.sync="showDialog" width="30%">
      <!-- status-icon属性会在表单验证时出现结果小图标 -->
      <el-form :model="form" :rules="rules" status-icon ref="form" label-width="80px">
        <el-form-item label="原密码" prop="currentPassword">
          <el-input v-model="form.currentPassword"></el-input>
        </el-form-item>
        <el-form-item label="新密码" prop="newPassword">
          <el-input v-model="form.newPassword"></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="confirmPassword">
          <el-input v-model="form.confirmPassword"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer">
        <el-button @click="showDialog = false">取消</el-button>
        <el-button @click="resetForm">重置</el-button>
        <el-button type="primary" @click="changePwd">确定</el-button>
      </span>
    </el-dialog>
  </span>
</template>

<script>
import * as userAPI from "@/api/user";

export default {
  data() {
    return {
      user: this.$store.state.user.user,
      form: {
        currentPassword: "",
        newPassword: "",
        confirmPassword: ""
      },
      showDialog: false,
      rules: {
        currentPassword: [
          { required: true, message: "请输入原密码", trigger: "blur" },
          // 自定义验证规则
          { validator: this.checkPwd, trigger: "blur" }
        ],
        newPassword: [
          { required: true, message: "请输入新密码", trigger: "blur" },
          { validator: this.checkNewPwd, trigger: ["change", "blur"] }
        ],
        confirmPassword: [
          { required: true, message: "请输入确认密码", trigger: "blur" },
          { validator: this.checkConfirmPwd, trigger: ["change", "blur"] }
        ]
      }
    };
  },
  methods: {
    handleCommand(command) {
      switch (command) {
        case "changePassword":
          this.showForm();
          break;
        case "logout":
          this.handleLogout();
          break;
        default:
          break;
      }
    },
    handleLogout() {
      this.$confirm("确定退出系统吗？").then(() => {
        this.doLogout();
      });
    },
    // 退出
    doLogout() {
      this.$store.dispatch("Logout");
      // 重定向到登录页
      this.$router.push("/login");
    },
    showForm() {
      this.showDialog = true;
      this.$nextTick(() => {
        this.resetForm();
      });
    },
    resetForm() {
      this.$refs["form"].resetFields();
    },
    // 验证密码
    // 表单自定义校验参考：https://element.eleme.cn/#/zh-CN/component/form#zi-ding-yi-xiao-yan-gui-ze
    checkPwd(rule, value, callback) {
      userAPI
        .checkPwd(this.user.id, value)
        .then(response => {
          callback();
        })
        .catch(response => {
          callback(new Error(response.data ? response.data.message : response));
        });
    },
    // 验证新密码和确认密码是否一致
    checkNewPwd(rule, value, callback) {
      // 刚输入新密码时，确认密码为空，不需要验证
      if (this.form.confirmPassword) {
        this.$refs["form"].validateField("confirmPassword");
      }
      callback();
    },
    // 验证新密码和确认密码是否一致
    checkConfirmPwd(rule, value, callback) {
      if (value === this.form.newPassword) {
        callback();
      } else {
        callback(new Error("新密码与确认密码不一致"));
      }
    },
    // 修改密码
    changePwd() {
      this.$refs["form"].validate(valid => {
        if (valid) {
          userAPI
            .changePwd(this.user.id, this.form.newPassword)
            .then(response => {
              this.$message({
                type: "success",
                message:
                  "密码修改成功，系统将在3秒后退出，请使用新密码重新登录",
                // 提示信息关闭后的回调函数
                onClose: this.doLogout
              });
            });
        } else {
          return false;
        }
      });
    }
  }
};
</script>

<style scoped>
.header-dropdown {
  position: absolute;
  right: 0;
  margin-right: 40px;
}
.header-username {
  color: #fff;
  cursor: pointer;
}
</style>

```

### 完事提交代码

```cmd
git add .
git commit -m "完成密码修改"
git push gitee user
```

## 样式优化
### 切换到master分支

```cmd
git checkout master
git pull gitee master
```

### 表格样式
table的表头默认时白色的，如果觉得颜色单调可以自己换的，表头样式通过el-table的header-cell-class-name属性来控制，指定一个class的名字即可

1. 在src/assets目录下添加override-elment-ui.css

```css
.el-table-header {
    background-color: #409EFF !important;
    color: #fff;
}
```
> 一定要加**!important**

2. main.js引入override-elment-ui.css

```js
import "@/assets/override-elment-ui.css";
```

3. 修改el-table上添加header-cell-class-name属性

```html
<el-table
  :data="list"
  border
  stripe
  height="480"
  header-cell-class-name="el-table-header"
>
```

### 表单校验图标样式
表单校验的状态小图标在校验通过时显示的是浅灰色小钩，不太醒目，如果绿色的就好了

修改src/assets/override-elment-ui.css

```css
/* 表头样式 */
.el-table-header {
    background-color: #409EFF !important;
    color: #fff;
}

/* 表单校验状态小图标样式 */
.el-form-item .el-icon-circle-check {
    color: #03abab;
}
```

> 其他自定义的样式都要自己去探索和研究
> 有些在官网文档提供了解决方案，有些官网没有，只能自己通过F12去探索
> 程序员本来就要学会研究、探索和举一反三的

## 合并所有代码

```cmd
git pull gitee
git checkout master
git merge member
git merge user
git push gitee master
```

> Vue全家桶的讲解到这里就结束了，谢谢大家！

